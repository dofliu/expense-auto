# NCUT 核銷自動填單系統 - 使用者操作指南與注意事項

這份文件旨在協助您單次或批次執行「NCUT 勤益科大核銷自動填單系統」。本專案目前已達成高度自動化，但在發票準備與實際存檔作業中，仍需要您提供協助，以確保每筆會計帳務皆 100% 正確。

---

## 1. 專案現況總結與環境限制

### 📌 系統已實現的功能

- **AI 智慧辨識 (OCR)**：利用 Google Gemini Vision 辨識您拍下的發票/收據照片，能抓出廠商名稱、總金額、日期，以及明細品項（含稅額獨立辨識）。
- **稅額智慧處理**：自動偵測發票上的稅額項目，並依據品項數量決定合併或拆分方式。
- **自動驗證碼破解**：自動取得 NCUT 核銷系統的數字驗證碼圖片並利用 AI 進行破解、登入。
- **自動導航填單**：穿梭系統多層次 Frameset，到達「**直接核銷（零用金）**」表單頁面進行自動填寫。
- **用途說明自動生成**：從系統取得計畫名稱與代號，自動組合出格式正確的用途說明（如 `計畫名稱(計畫代碼)-品項摘要`）。
- **批次合併處理**：支援將 `receipts/` 目錄內的多張收據合併為一筆「總請購單」。
- **國外收據支援**：支援 Anthropic、Google Cloud、OpenAI 等外幣電子帳單，搭配信用卡刷卡紀錄自動比對台幣金額。

### ⚠️ 使用者需知的前置設定

- `credentials.env`：系統依賴 `NCUT_USERNAME` (員工編號)、`NCUT_PASSWORD`，以及 `GEMINI_API_KEY` 的可用性。
- 此工具目前**僅涵蓋「直接核銷（零用金）」**的情境。

---

## 2. 發票與收據的準備：拍攝規範

### ✅ 拍攝完整性

- 發票上的**「日期」、「廠商名稱/店名標誌章」、「總金額」與「明細清單（品名、數量、單價）」**必須完整入鏡。
- 如果是手開收據，需確保開立單位的**字跡端正**。
- 若發票上有寫「稅額」或「營業稅」，AI 會自動辨識並獨立處理。

### ✅ 稅額的拍攝注意事項

- **單品項 + 稅額**：AI 會自動將稅額併入品項總價（例：品項 457 + 稅額 23 → 直接填 480）。
- **多品項 + 稅額**：AI 會各品項填原價，稅額合計放入「其他差額」行。
- 請確保稅額數字拍攝清楚，以免 AI 辨識錯誤。

### ✅ 多張發票一起拍（合併功能）

- 可將多張小發票並排擺放拍攝進同一張照片。
- 注意**平放、不折疊、不重疊**。

### ✅ 國外 AI 服務收據（Anthropic / Google Cloud / OpenAI 等）

- **直接將收據截圖放入 `receipts/`** 即可，系統已支援辨識英文收據。
- **外幣匯率處理**：請同時將信用卡刷卡紀錄截圖一併放入 `receipts/` 資料夾。
  - AI 會自動辨識哪些是收據、哪些是刷卡紀錄。
  - 然後根據廠商名稱、金額、日期自動交叉比對，找到對應的台幣入帳金額。
  - **不需要您手動輸入匯率**。
- 若自動匹配失敗，終端機會提示您手動確認台幣金額。

### ✅ 支援格式與存放位置

- 支援 `.jpg`、`.jpeg`、`.png`、`.webp`。
- 放入專案根目錄的 `receipts/` 資料夾。

---

## 3. 執行中：使用者需要提供的協助

### 步驟 A：確認 OCR 辨識結果

啟動 `python main.py` 後，系統會列出辨識摘要。
👉 **請核對**：

- 總金額是否與手上的實體發票相符
- 外幣收據是否有成功匹配到刷卡紀錄的台幣金額
- 若有嚴重錯誤，輸入 `n` 取消

### 步驟 B：指示經費種類

👉 程式會詢問「部門採購 / 計畫請購」，請依據資金來源選擇。

### 步驟 C：自動填寫與最後手動存檔

程式會依序填寫：

1. **APPY（計畫/經費）** → 取得計畫名稱與代碼
2. **用途說明** → 自動產生，格式為「計畫名稱(代碼)-品項摘要」
3. **APPP（品項明細）** → 含稅額智慧處理
4. **APPA（受款人）** → 含自動產生收據編號

👉 **人工最終覆核並【手動存檔】**：

- 核對會計科目（預設為「材料及用品費」）
- 留意品項上限 **14 項**
- 確認填入的用途說明是否正確
- **完成所有核對後，點擊網頁上的「存入」按鈕**

### 步驟 D：會後清理

👉 核銷完成後，請將 `receipts/` 裡的照片移除或備份，避免下次重複報帳。
